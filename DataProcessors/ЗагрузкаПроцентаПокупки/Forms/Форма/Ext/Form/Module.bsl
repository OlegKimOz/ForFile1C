
&НаКлиенте
Процедура ИмяФайлаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	ДиалогВыбФайла 	 = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбФайла.Заголовок				= "Выберите файл для загрузки:";
	ДиалогВыбФайла.ПолноеИмяФайла			= Объект.ИмяФайла; //АДРЕС
	ДиалогВыбФайла.Фильтр					= "Excel (*.xlsx)|*.xls*";
	ДиалогВыбФайла.Расширение				= "xlsx";
	ДиалогВыбФайла.МножественныйВыбор		= Ложь;
	ДиалогВыбФайла.ПредварительныйПросмотр	= Ложь;
	ДиалогВыбФайла.Показать(Новый ОписаниеОповещения("ПослеВыбораФайла", ЭтаФорма));
	
	
	
	
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораФайла(ВыбранныеФайлы, ДопПарметры) Экспорт
	Если ЗначениеЗаполнено(ВыбранныеФайлы) и ВыбранныеФайлы.Количество() > 0 Тогда
		 Объект.ИмяФайла = ВыбранныеФайлы[0];
		
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Старт(Команда)
	// Вставить содержимое обработчика.
	
	// Запишу файл строку 
	// 1  Имя файла
   //  2   - Должник (в шаблоне)
   //  3   - Номер договора (в шаблоне)
   //  4   - Процент покупки (в шаблоне)
   
   
     должникЗаг="";
	 
	 // найдем должника
     стрДолж= ДолжникКолонка(Объект.ИмяШаблона);
	 стрДогДолж= ДоговорКолонка(Объект.ИмяШаблона);

	 загодин=Ложь;
	 
	  фамилия= стрДолж["Фамилия"];
	  имя=стрДолж["Имя"];
	  отчество=стрДолж["Отчество"];
	  
	  Если фамилия=имя Тогда
		  //Значит  один заголовок для Должника
		  должникЗаг=фамилия;
		  загодин=Истина;
	  Иначе
		  //пока вернемся
		    Возврат;
			
			
			
			
		  
	  КонецЕсли;	  
	  
	  //  найдем договор 
	  
	  номерДогЗаг="";
	  
	  номердоговора=стрДогДолж["НомерДоговора"];
	  процентПокупки=стрДогДолж["ПроцентПокупки"];
	  
	  
	  
	  // запишу врем файл и передам его  обработчику
	  
	   Shell = Новый COMОбъект("WScript.Shell");
      дирМоиД=Shell.SpecialFolders.Item("MyDocuments");

	  
	  имяфайлатемп=дирМоиД+"\процпокупки.txt";
	  имяэксел=Объект.ИмяФайла;
	  
	  
	  ФайлТемп = Новый ЗаписьТекста(имяфайлатемп);
      ФайлТемп.ЗаписатьСтроку(должникЗаг);
      ФайлТемп.ЗаписатьСтроку(номердоговора);
	  ФайлТемп.ЗаписатьСтроку(процентПокупки);
	  ФайлТемп.ЗаписатьСтроку(Объект.ИмяФайла);
	  
      ФайлТемп.Закрыть();
	  
	  программаОбр=дирМоиД+"\ExcelParse.exe";
	  
	  WshShell = Новый COMОбъект("WScript.Shell");
			   
     
	  
	  Если  загодин Тогда
	  
		  Если ПроцентВЯчейке Тогда
			  
			  программаОбр=программаОбр+" "+"1";

		  Иначе	  
		  	  программаОбр=программаОбр+" "+"1_1";

		  
		  КонецЕсли;
		  
		  		   
		   
		   WshShell.Run(программаОбр,1, 1);


	  
	  Иначе
		  
		  программаОбр=программаОбр+" "+"2";
	  	
	  
	  КонецЕсли;
	  
	 
	  
	  
	  
	  
	  //Сообщить(имяфайлатемп);
  
	   имяфайлатемпответ=дирМоиД+"\tempprobuy.txt";
	   
	    мСтрокФайла = Новый Массив();

	   
	   ВыбранныйФайл = Новый Файл(имяфайлатемпответ);
	   Если ВыбранныйФайл.Существует() Тогда
		   
		   
	    	   											
											//прочитать строку считывает одну строку из файла
											//если достигнут конец файла, то возвращается значение НЕОПРЕДЕЛЕНО
											
									 
					ПрочитанныйТекст = Новый ЧтениеТекста(имяфайлатемпответ, КодировкаТекста.UTF8);
												
					Строка = ПрочитанныйТекст.ПрочитатьСтроку();
												//а не был ли файл пуст?
					Если Строка <> Неопределено Тогда
					     мСтрокФайла.Добавить(Строка);
					КонецЕсли;
					
					Пока Строка <> Неопределено Цикл
                       Строка = ПрочитанныйТекст.ПрочитатьСтроку();
					     Если Строка <> Неопределено Тогда
					          мСтрокФайла.Добавить(Строка);
					     КонецЕсли;
					КонецЦикла;


		   
       КонецЕсли;
	   
	   
	    должДанныет=Новый Структура;
	   
	   Для каждого стрд  Из мСтрокФайла Цикл
		   
		      должДанныет=РазбитьСтроку(стрд);
			  
			  //Сообщить("фио: "-должДанныет.ФИО+"-номер: " + должДанныет.Номер+"-процент:"+должДанныет.ЦенаПокупки);
			  
			  Запись=Объект.ТЧ.Добавить();
			  Запись.Должник=должДанныет.ФИО;
			  Запись.НомерДоговора=должДанныет.Номер;
			  Запись.ПроцентПокупки=должДанныет.ЦенаПокупки;
			  
			  
			 
	   
	   КонецЦикла;
	   
	   
	   
	   
	  
	
	
	Сообщить("Ок");
КонецПроцедуры


&НаКлиенте
Функция РазбитьСтроку(Стр)

	 должДанные=Новый Структура;

	 позфио=Найти(Стр,":");
	 
	 фиостр=Лев(Стр,позфио-1);
	 
	 должДанные.Вставить("ФИО",фиостр);
	 
	 
	 длинастр=СтрДлина(Стр);
	 
	 строкаспр=Прав(Стр,длинастр-позфио);
	 
	 позномерд=Найти(строкаспр,":");
	 
	 номерстрд=Лев(строкаспр,позномерд-1);
	 
	 
	 должДанные.Вставить("Номер",номерстрд);
	 
	 
	 
	 длинаост= СтрДлина(строкаспр);
	 
	 строкаспр=Прав(Стр,длинаост-позномерд);
	 
	 должДанные.Вставить("ЦенаПокупки",строкаспр);
	 
	 
	 Возврат   должДанные;
КонецФункции // ()




&НаСервере
Функция ДолжникКолонка(шаблонф)

	
	//    Получить должника Колонку
	
	должФИО=Новый Структура;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ШаблоныФайловДолжники.Реквизит КАК Реквизит,
		|	ШаблоныФайловДолжники.Заголовки КАК Заголовки
		|ИЗ
		|	Справочник.ШаблоныФайлов.Должники КАК ШаблоныФайловДолжники
		|ГДЕ
		|	ШаблоныФайловДолжники.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", шаблонф);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
	    должФИО.Вставить(ВыборкаДетальныеЗаписи.Реквизит,ВыборкаДетальныеЗаписи.Заголовки);
	 
		
	КонецЦикла;

	
	Возврат должФИО;
	  
	

КонецФункции // ()




&НаСервере
Функция ДоговорКолонка(шаблонф)

	договорДолж=Новый Структура;
	  
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ШаблоныФайловДоговоры.Реквизит КАК Реквизит,
		|	ШаблоныФайловДоговоры.Заголовки КАК Заголовки
		|ИЗ
		|	Справочник.ШаблоныФайлов.Договоры КАК ШаблоныФайловДоговоры
		|ГДЕ
		|	ШаблоныФайловДоговоры.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", шаблонф);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
		договорДолж.Вставить(ВыборкаДетальныеЗаписи.Реквизит,ВыборкаДетальныеЗаписи.Заголовки);
		
	КонецЦикла;
	  
	  
	 Возврат договорДолж; 
	  

КонецФункции // ()

&НаКлиенте
Процедура ЗагрузитьВБазу(Команда)
	
	 массив=Новый Массив();  
	
	  Для каждого стр  Из Объект.ТЧ Цикл
		  
	     соб=ЗаписатьПроцент(стр.Должник,стр.НомерДоговора,стр.ПроцентПокупки);

		Если соб<>"" Тогда
		
			 массив.Добавить(соб);
		
		КонецЕсли; 
		    
	  	
	  
	  КонецЦикла;
	
	  
	   Shell = Новый COMОбъект("WScript.Shell");
       дирМоиД=Shell.SpecialFolders.Item("MyDocuments");
	   
	   
	   ПутьКФайлу=дирМоиД+"\ошибкизагр.txt";
	   
	   Если ЗначениеЗаполнено(ПутьКФайлу) Тогда

			ТекстовыйДок = Новый ТекстовыйДокумент;
			
			
			Для каждого стр  Из массив Цикл
			
				 ТекстовыйДок.ДобавитьСтроку(стр);
			
			КонецЦикла;
			
		
			
			
			ТекстовыйДок.Записать(ПутьКФайлу, КодировкаТекста.UTF8);

		Конецесли;

	  
	  
	
	
	
	Сообщить("Загружено");
КонецПроцедуры







&НаСервере
Функция ЗаписатьПроцент(долж,номерд,процентпок)

	Перем ссылкаДог;

	собвозвр="";
	
	владелДолж=Справочники.Должники.НайтиПоНаименованию(долж);

	
	 	//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Договоры.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Договоры КАК Договоры
		|ГДЕ
		|	Договоры.Владелец.Наименование = &Наименование
		|	И Договоры.НомерДоговора = &НомерДоговора";
	
	Запрос.УстановитьПараметр("Наименование", долж);
	Запрос.УстановитьПараметр("НомерДоговора", номерд);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
		 ссылкаДог=ВыборкаДетальныеЗаписи.Ссылка;
	КонецЦикла;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

	
	//
	//Запрос = Новый Запрос;
	//Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	Договоры.Владелец.Ссылка КАК ВладелецСсылка,
	//	|	Договоры.Ссылка КАК Ссылка
	//	|ИЗ
	//	|	Справочник.Договоры КАК Договоры
	//	|ГДЕ
	//	|	Договоры.Владелец.Ссылка = &Ссылка
	//	|	И Договоры.НомерДоговора = &НомерДоговора";
	//
	//Запрос.УстановитьПараметр("НомерДоговора", номерд);
	//Запрос.УстановитьПараметр("Ссылка", владелДолж);
	//
	//РезультатЗапроса = Запрос.Выполнить();
	//
	//ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	//
	//Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	//	// Вставить обработку выборки ВыборкаДетальныеЗаписи
	//	  ссылкаДог=ВыборкаДетальныеЗаписи.Ссылка;
	//	
	//КонецЦикла;
	//
	
	  Если ссылкаДог<>Неопределено Тогда
	  
           договор = ссылкаДог.ПолучитьОбъект();
           договор.ПроцентПокупки = процентпок; 
           договор.Записать();	
	   Иначе
		   Сообщить("Нет в базе такого должника - "+долж + " или нет такого договора " + номерд);
		   собвозвр="Нет в базе такого должника - "+долж + " или нет такого договора " + номерд; 
		   
	  КонецЕсли;

	  
	 Возврат собвозвр;


КонецФункции // ()











