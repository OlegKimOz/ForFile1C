
&НаКлиенте
Процедура Старт(Команда)
	// Запишу файл строку 
	// 1  Имя файла
   //  2   - Должник (в шаблоне)
   //  3   - Номер договора (в шаблоне)
   //  4   - Договор цессии (в шаблоне)
   //  5   - Дата цессии 
   
   
   
    должникЗаг="";
	 
	 // найдем должника
     стрДолж= ДолжникКолонка(Объект.ИмяШаблона);
	 стрДогДолж= ДоговорКолонка(Объект.ИмяШаблона);
	 стрДогЦессии=ДогЦессииКолонка(Объект.ИмяШаблона);
	 

	 загодин=Ложь;
	 
	  фамилия= стрДолж["Фамилия"];
	  имя=стрДолж["Имя"];
	  отчество=стрДолж["Отчество"];
	  
	  Если фамилия=имя Тогда
		  //Значит  один заголовок для Должника
		  должникЗаг=фамилия;
		  загодин=Истина;
	  Иначе
		  //пока вернемся
		    Возврат;
			
			
			
			
		  
	  КонецЕсли;	  
	  
	  //  найдем договор 
	  
	  номерДогЗаг="";
	  
	  номердоговора=стрДогДолж["НомерДоговора"];
	  //процентПокупки=стрДогДолж["ПроцентПокупки"];
	  
	  
	  номердогЦессии=стрДогЦессии["НомерДоговора"];
	  датаЦессии=стрДогЦессии["ДатаЦессии"];
	  
	  
	  
	   Shell = Новый COMОбъект("WScript.Shell");
        дирМоиД=Shell.SpecialFolders.Item("MyDocuments");

	  

	  Если Х2=Истина  Тогда
			   
			    прогрпуть="D:\public\Distr";
		 
		        имяфайлатемп=прогрпуть+"\догцессииобр.txt";

				
				имяфайлатемпответ=прогрпуть+"\догцессииобр_out.txt";

    			 программаОбр=прогрпуть+"\ParseExcel86.exe";
		   
	   Иначе
			   
			   имяфайлатемп=дирМоиД+"\догцессииобр.txt";
			   
			   имяфайлатемпответ=дирМоиД+"\догцессииобр_out.txt";

			   программаОбр=дирМоиД+"\ExcelParse.exe";
			   
	   КонецЕсли; 
		   

	    имяэксел=Объект.ИмяФайла;
	  
	  
		  ФайлТемп = Новый ЗаписьТекста(имяфайлатемп);
	      ФайлТемп.ЗаписатьСтроку(должникЗаг);
	      ФайлТемп.ЗаписатьСтроку(номердоговора);
		  //ФайлТемп.ЗаписатьСтроку(процентПокупки);
		  
		  ФайлТемп.ЗаписатьСтроку(номердогЦессии);
		  ФайлТемп.ЗаписатьСтроку(датаЦессии);
		  
		  
		  ФайлТемп.ЗаписатьСтроку(Объект.ИмяФайла);
		  
	      ФайлТемп.Закрыть();

	   
		  
		   
		 программаОбр=программаОбр+" "+"11";

			 
			 
		  Shell.Run(программаОбр,0, 1);

		  мСтрокФайла = Новый Массив();

		  
		   ВыбранныйФайл = Новый Файл(имяфайлатемпответ);
		   Если ВыбранныйФайл.Существует() Тогда

			     	ПрочитанныйТекст = Новый ЧтениеТекста(имяфайлатемпответ, КодировкаТекста.UTF8);
												
					Строка = ПрочитанныйТекст.ПрочитатьСтроку();
												//а не был ли файл пуст?
					Если Строка <> Неопределено Тогда
					     мСтрокФайла.Добавить(Строка);
					КонецЕсли;
					

					Пока Строка <> Неопределено Цикл
                       Строка = ПрочитанныйТекст.ПрочитатьСтроку();
					     Если Строка <> Неопределено Тогда
					          мСтрокФайла.Добавить(Строка);
					     КонецЕсли;
					КонецЦикла;

			   
			   
			   
		   КонецЕсли;	   
		  
		   
		   
		   
				 ВыпискаДанныет=Новый Структура;

				   массивЗаг=Новый Массив;
				
				   массивЗаг.Добавить("ФИО");
                   массивЗаг.Добавить("НомерДоговора");
				   массивЗаг.Добавить("НомерЦессии");
				   массивЗаг.Добавить("ДатаЦессии");
				   
				 
				 
				 Для каждого стрд  Из мСтрокФайла Цикл
					 
					 Если стрд<>"" Тогда
					       ВыпискаДанныет=РазбитьСтроку(стрд,массивЗаг);
					  Запись=Объект.ТЧ.Добавить();
					  
  				      Запись.НомерДоговора=ВыпискаДанныет.НомерДоговора;
					  Запись.Должник=ВыпискаДанныет.ФИО;
                      Запись.ДоговорЦессии=ВыпискаДанныет.НомерЦессии;
					  Запись.ДатаЦессии=ВыпискаДанныет.ДатаЦессии;
					  

					 	
					 
					 КонецЕсли;
					 
					 					  
					  
					  
					 
					 
				 КонецЦикла;

					 
					 
	   
	
	
	
	
  КонецПроцедуры
  
  &НаКлиенте
Функция РазбитьСтроку(стрк, массивзаг)

   ВыпискаДанные=Новый Структура;

	
	Разделитель = ":";
    Строки = СтрЗаменить(стрк, Разделитель, Символы.ПС);
    Для Индекс = 1 По СтрЧислоСтрок(Строки) Цикл
		
			ВыпискаДанные.Вставить(массивзаг[Индекс-1],СтрПолучитьСтроку(Строки, Индекс));
		
		
    КонецЦикла;
	
	
	
	Возврат ВыпискаДанные; 	

КонецФункции // ()

  
  
  
&НаСервере
Функция ДогЦессииКолонка(шаблонф)
	
	договорЦессии=Новый Структура;
	
	 
	      	//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ШаблоныФайловДоговорЦессии.Реквизит КАК Реквизит,
		|	ШаблоныФайловДоговорЦессии.Заголовок КАК Заголовок
		|ИЗ
		|	Справочник.ШаблоныФайлов.ДоговорЦессии КАК ШаблоныФайловДоговорЦессии";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		договорЦессии.Вставить(ВыборкаДетальныеЗаписи.Реквизит,ВыборкаДетальныеЗаписи.Заголовок);
		
	КонецЦикла;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

    Возврат договорЦессии;	
	
	
КонецФункции // ()
	
  
  &НаСервере
Функция ДолжникКолонка(шаблонф)

	
	//    Получить должника Колонку
	
	должФИО=Новый Структура;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ШаблоныФайловДолжники.Реквизит КАК Реквизит,
		|	ШаблоныФайловДолжники.Заголовки КАК Заголовки
		|ИЗ
		|	Справочник.ШаблоныФайлов.Должники КАК ШаблоныФайловДолжники
		|ГДЕ
		|	ШаблоныФайловДолжники.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", шаблонф);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
	    должФИО.Вставить(ВыборкаДетальныеЗаписи.Реквизит,ВыборкаДетальныеЗаписи.Заголовки);
	 
		
	КонецЦикла;

	
	Возврат должФИО;
	  
	

КонецФункции // ()



&НаСервере
Функция ДоговорКолонка(шаблонф)

	договорДолж=Новый Структура;
	  
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ШаблоныФайловДоговоры.Реквизит КАК Реквизит,
		|	ШаблоныФайловДоговоры.Заголовки КАК Заголовки
		|ИЗ
		|	Справочник.ШаблоныФайлов.Договоры КАК ШаблоныФайловДоговоры
		|ГДЕ
		|	ШаблоныФайловДоговоры.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", шаблонф);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
		договорДолж.Вставить(ВыборкаДетальныеЗаписи.Реквизит,ВыборкаДетальныеЗаписи.Заголовки);
		
	КонецЦикла;
	  
	  
	 Возврат договорДолж; 
	  

КонецФункции // ()


  
  

&НаКлиенте
Процедура ИмяФайлаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	ДиалогВыбФайла 	 = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбФайла.Заголовок				= "Выберите файл для загрузки:";
	ДиалогВыбФайла.ПолноеИмяФайла			= Объект.ИмяФайла; //АДРЕС
	ДиалогВыбФайла.Фильтр					= "Excel (*.xlsx)|*.xls*";
	ДиалогВыбФайла.Расширение				= "xlsx";
	ДиалогВыбФайла.МножественныйВыбор		= Ложь;
	ДиалогВыбФайла.ПредварительныйПросмотр	= Ложь;
	ДиалогВыбФайла.Показать(Новый ОписаниеОповещения("ПослеВыбораФайла", ЭтаФорма));
	

КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораФайла(ВыбранныеФайлы, ДопПарметры) Экспорт
	Если ЗначениеЗаполнено(ВыбранныеФайлы) и ВыбранныеФайлы.Количество() > 0 Тогда
		 Объект.ИмяФайла = ВыбранныеФайлы[0];
		
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Загрузить(Команда)
	
	       //  Пройдусь по таблице
	   
	   Для каждого стр Из Объект.ТЧ  Цикл
		   
		     ЗаписатьДоговорЦессии(стр.Должник,стр.НомерДоговора ,стр.ДоговорЦессии ,стр.ДатаЦессии)
 
		   
	   	
	   
	   КонецЦикла;

	   Сообщить("Ок");
	
КонецПроцедуры




&НаСервере
Процедура ЗаписатьДоговорЦессии(долж,договор,догЦессии,датаЦессии)

     Перем ссылкаДог;
	 
	 НоваяДата = Дата(датаЦессии+" 00:00:00");
	 
	 

	 собвозвр="";
	
	 владелДолж=Справочники.Должники.НайтиПоНаименованию(долж);
	 допРеквизитДогЦессии=Справочники.ДополнительныеРеквизиты.НайтиПоНаименованию("Договор цессии");
	 допРеквизитДатаЦессии=Справочники.ДополнительныеРеквизиты.НайтиПоНаименованию("Дата цессии");
	 
	 
	 

	 
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	Договоры.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.Договоры КАК Договоры
				|ГДЕ
				|	Договоры.Владелец.Наименование = &Наименование
				|	И Договоры.НомерДоговора = &НомерДоговора";
			
			Запрос.УстановитьПараметр("Наименование", долж);
			Запрос.УстановитьПараметр("НомерДоговора", договор);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				// Вставить обработку выборки ВыборкаДетальныеЗаписи
				 ссылкаДог=ВыборкаДетальныеЗаписи.Ссылка;
			КонецЦикла;

			     
				   Если ссылкаДог<>Неопределено Тогда
					   
					 Попытка
						 
						  	
									Запрос = Новый Запрос;
									Запрос.Текст = 
										"ВЫБРАТЬ
										|	ДоговорЦессии.НомерДоговора КАК НомерДоговора,
										|	ДоговорЦессии.ДатаЦессии КАК ДатаЦессии
										|ИЗ
										|	Справочник.ДоговорЦессии КАК ДоговорЦессии
										|ГДЕ
										|	ДоговорЦессии.Владелец = &Владелец
										|	И ДоговорЦессии.НомерДоговора = &НомерДоговора";
									
									Запрос.УстановитьПараметр("Владелец", ссылкаДог);
									Запрос.УстановитьПараметр("НомерДоговора", догЦессии);
									
									РезультатЗапроса = Запрос.Выполнить();
									
									ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
									
									Если ВыборкаДетальныеЗаписи.Количество()=0   Тогда
										
													     	 
										   Запись=Справочники.ДоговорЦессии.СоздатьЭлемент();
										   Запись.Владелец= ссылкаДог;
										   Запись.НомерДоговора=догЦессии;
										   Запись.ДатаЦессии= НоваяДата;
										   
										   Запись.Записать();

													
									
									КонецЕсли;
									
								    										
						  
									Запрос = Новый Запрос;
									Запрос.Текст = 
										"ВЫБРАТЬ
										|	ДополнительныеДанные.Реквизит КАК Реквизит,
										|	ДополнительныеДанные.Наименование КАК Наименование
										|ИЗ
										|	Справочник.ДополнительныеДанные КАК ДополнительныеДанные
										|ГДЕ
										|	ДополнительныеДанные.Владелец = &Владелец
										|	И ДополнительныеДанные.Реквизит = &Реквизит
										|	И ДополнительныеДанные.Наименование = &Наименование";
									
									Запрос.УстановитьПараметр("Владелец", владелДолж);
									Запрос.УстановитьПараметр("Наименование",догЦессии );
									Запрос.УстановитьПараметр("Реквизит", допРеквизитДогЦессии);
									
									РезультатЗапроса = Запрос.Выполнить();
									
									Выборка = РезультатЗапроса.Выбрать();
									
									
									Если  Выборка.Количество()=0  Тогда
									
										   ЗаписьД=Справочники.ДополнительныеДанные.СоздатьЭлемент();
										   ЗаписьД.Владелец=владелДолж;
										   ЗаписьД.Наименование=догЦессии;
										   ЗаписьД.Реквизит=допРеквизитДогЦессии;
										   ЗаписьД.Записать();
										   
								   
								   
										   ЗаписьДД=Справочники.ДополнительныеДанные.СоздатьЭлемент();
										   ЗаписьДД.Владелец=владелДолж;
										   ЗаписьДД.Наименование=датаЦессии;
										   ЗаписьДД.Реквизит=допРеквизитДатаЦессии;
										   ЗаписьДД.Записать();
										   
								
									
									КонецЕсли;
					   
							   
							   
					   
					   
					   
					   
					   //   Договор цессии
					   //   Дата цессии
					   
					   
					 
					 Исключение
						 
						 
					 КонецПопытки;  
					   
					 					   
					   
					  	
					   //
					   
				   Иначе
					   //Сообщить("Нет в базе такого должника - "+долж + " или нет такого договора " + номерд);
					   //собвозвр="Нет в базе такого должника - "+долж + " или нет такого договора " + номерд; 
					   
				  КонецЕсли;

			
			
			
	
	
	
КонецПроцедуры


